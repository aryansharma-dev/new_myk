import{r as y,S as H,d as K,j as e,a as L,B as n,b}from"./index-Du1wZ1pu.js";import{T as _}from"./Title-CaBRCAqF.js";import{C as V}from"./CartTotal-BLd9aFHe.js";import{u as Y}from"./usePageMetadata-CED4SOpM.js";import{a as Z}from"./productImages-rNWg_BiP.js";const ee=()=>{const[u,v]=y.useState("cod"),{navigate:x,token:A,cartItems:k,setCartItems:g,getCartAmount:z,delivery_fee:I,productMap:P,ensureProductLoaded:D}=y.useContext(H),N=K(),[S,j]=y.useState(!1),[p,T]=y.useState({firstName:"",lastName:"",email:"",street:"",city:"",state:"",zipcode:"",country:"",phone:""}),h=y.useRef(null),C=!!"rzp_live_RI9hesA7lA1MKs".trim();y.useEffect(()=>{A||x("/login",{replace:!0,state:{from:(N==null?void 0:N.pathname)||"/"}})},[A,x,N]);const U=y.useMemo(()=>({absoluteCanonical:a,baseTitle:c,pageDescription:d})=>[{"@context":"https://schema.org","@type":"CheckoutPage","@id":`${a}#place-order`,url:a,name:c,description:d,paymentAccepted:u==="cod"?["Cash"]:["Card","OnlinePayment"],potentialAction:{"@type":"PayAction",target:a}}],[u]);Y({title:"Secure Checkout Details",description:"Provide delivery information and choose a payment method to place your TinyMillion order securely.",keywords:"TinyMillion place order, delivery form, payment method, secure checkout",canonical:"/place-order",robots:"noindex, nofollow",structuredData:U});const f=a=>{const c=a.target.name,d=a.target.value;T(o=>({...o,[c]:d}))},R=y.useCallback(()=>typeof window<"u"&&window.Razorpay?Promise.resolve(!0):(h.current||(h.current=new Promise((a,c)=>{if(typeof document>"u"){c(new Error("Document is unavailable to load Razorpay"));return}const d=m=>{m.addEventListener("load",()=>{a(!0)},{once:!0}),m.addEventListener("error",()=>{c(new Error("Failed to load Razorpay checkout"))},{once:!0})},o=document.getElementById("razorpay-sdk");if(o){d(o);return}const l=document.createElement("script");l.id="razorpay-sdk",l.src="https://checkout.razorpay.com/v1/checkout.js",l.async=!0,d(l),document.body.appendChild(l)}).catch(a=>{throw h.current=null,a})),h.current),[]);y.useEffect(()=>{u==="razorpay"&&C&&R().catch(a=>{console.warn(a)})},[u,R,C]);const F=async a=>{try{await R()}catch(o){console.error(o),n.error((o==null?void 0:o.message)||"Failed to load Razorpay");return}const c={key:(a==null?void 0:a.key)||"rzp_live_RI9hesA7lA1MKs",amount:a.amount,currency:a.currency,name:"Order Payment",description:"Order Payment",order_id:a.id,receipt:a.receipt,handler:async o=>{var l,m;try{const{data:i}=await b.post("/api/order/verifyRazorpay",o);i.success?(x("/orders"),g({})):n.error(i.message||"Verification failed")}catch(i){console.error(i),n.error(((m=(l=i==null?void 0:i.response)==null?void 0:l.data)==null?void 0:m.message)||i.message)}}};if(!(window!=null&&window.Razorpay)){n.warn("Razorpay SDK is unavailable. Simulating success."),x("/orders"),g({});return}new window.Razorpay(c).open()},M=y.useCallback(async(a=u)=>{const c=k||{},d=new Set;for(const t in c)Object.prototype.hasOwnProperty.call(c,t)&&d.add(String(t));const o=new Map;await Promise.all(Array.from(d).filter(Boolean).map(async t=>{const r=P.get(t);if(r){o.set(t,r);return}const s=await D(t);s&&o.set(t,s)}));const l=[];for(const t in c){if(!Object.prototype.hasOwnProperty.call(c,t))continue;const r=c[t]||{},s=o.get(String(t))||P.get(String(t));if(s)for(const E in r){if(!Object.prototype.hasOwnProperty.call(r,E))continue;const q=Number(r[E])||0;if(q<=0)continue;const B=Z(s)||null;l.push({product:s._id,name:s.name,price:Number(s.price)||0,size:E,quantity:q,image:B})}}const m=Number(z?z():0)||0,i=Number(I||0)||0,w=m+i;return{address:p,cartItems:l,items:l,totalAmount:w,amount:w,subtotal:m,deliveryFee:i,paymentMethod:a}},[k,D,z,I,p,u,P]),O=()=>Object.keys(k||{}).length===0,$=async a=>{var c,d,o,l,m,i,w;if(a.preventDefault(),O()){n.info("Cart is empty. Add items before placing order.");return}if(!/^\d{10}$/.test(p.phone||"")){n.info("Please enter a valid 10-digit phone number.");return}j(!0);try{const t=await M();if(!((c=t==null?void 0:t.cartItems)!=null&&c.length)){n.error("Unable to prepare your order. Please refresh and try again."),j(!1);return}if(!C&&u!=="cod"){n.info("Online payments disabled in this environment. Using Cash on Delivery instead.");const r=await M("cod"),{data:s}=await b.post("/api/order/place",r);s.success?(n.success(s.message||"Order placed"),v("cod"),g({}),x("/orders")):n.error(s.message||"Unable to place order"),j(!1);return}switch(u){case"cod":{const{data:r}=await b.post("/api/order/place",t);r.success?(n.success(r.message||"Order placed"),g({}),x("/orders")):n.error(r.message||"Unable to place order");break}case"stripe":{const{data:r}=await b.post("/api/order/stripe",t);if(r.success){const s=((d=r==null?void 0:r.data)==null?void 0:d.session_url)||r.session_url;s?window.location.replace(s):n.info("Stripe session created (no redirect URL returned)")}else n.error(r.message||"Stripe checkout failed");break}case"razorpay":{const{data:r}=await b.post("/api/order/razorpay",t);if(r.success){const s=((o=r==null?void 0:r.data)==null?void 0:o.order)||r.order;s!=null&&s.id?await F({...s,key:((l=r==null?void 0:r.data)==null?void 0:l.key)||r.key}):(n.success(r.message||"Payment completed"),x("/orders"),g({}))}else n.error(r.message||"Razorpay payment failed");break}default:n.error("Unknown payment method");break}}catch(t){console.error(t),((m=t==null?void 0:t.response)==null?void 0:m.status)===401&&(localStorage.removeItem("token"),x("/login")),n.error(((w=(i=t==null?void 0:t.response)==null?void 0:i.data)==null?void 0:w.message)||t.message||"Something went wrong")}finally{j(!1)}};return e.jsxs("form",{onSubmit:$,className:"flex flex-col sm:flex-row justify-between gap-4 pt-5 sm:pt-14 min-h-[80vh] border-t px-4 md:px-8",children:[e.jsxs("div",{className:"flex flex-col gap-4 w-full sm:max-w-[480px]",children:[e.jsx("div",{className:"text-xl sm:text-2xl my-3",children:e.jsx(_,{text1:"DELIVERY",text2:"INFORMATION"})}),e.jsxs("div",{className:"flex gap-3 flex-col sm:flex-row",children:[e.jsx("input",{required:!0,onChange:f,name:"firstName",value:p.firstName,className:"border border-gray-300 rounded py-1.5 px-3.5 w-full",type:"text",placeholder:"First name"}),e.jsx("input",{required:!0,onChange:f,name:"lastName",value:p.lastName,className:"border border-gray-300 rounded py-1.5 px-3.5 w-full",type:"text",placeholder:"Last name"})]}),e.jsx("input",{required:!0,onChange:f,name:"email",value:p.email,className:"border border-gray-300 rounded py-1.5 px-3.5 w-full",type:"email",placeholder:"Email address"}),e.jsx("input",{required:!0,onChange:f,name:"street",value:p.street,className:"border border-gray-300 rounded py-1.5 px-3.5 w-full",type:"text",placeholder:"Street"}),e.jsxs("div",{className:"flex gap-3 flex-col sm:flex-row",children:[e.jsx("input",{required:!0,onChange:f,name:"city",value:p.city,className:"border border-gray-300 rounded py-1.5 px-3.5 w-full",type:"text",placeholder:"City"}),e.jsx("input",{onChange:f,name:"state",value:p.state,className:"border border-gray-300 rounded py-1.5 px-3.5 w-full",type:"text",placeholder:"State"})]}),e.jsxs("div",{className:"flex gap-3 flex-col sm:flex-row",children:[e.jsx("input",{required:!0,onChange:f,name:"zipcode",value:p.zipcode,className:"border border-gray-300 rounded py-1.5 px-3.5 w-full",type:"text",placeholder:"Zipcode"}),e.jsx("input",{required:!0,onChange:f,name:"country",value:p.country,className:"border border-gray-300 rounded py-1.5 px-3.5 w-full",type:"text",placeholder:"Country"})]}),e.jsx("input",{required:!0,onChange:f,name:"phone",value:p.phone,className:"border border-gray-300 rounded py-1.5 px-3.5 w-full",type:"tel",placeholder:"Phone"})]}),e.jsxs("div",{className:"mt-8",children:[e.jsx("div",{className:"mt-8 min-w-80",children:e.jsx(V,{})}),e.jsxs("div",{className:"mt-12",children:[e.jsx(_,{text1:"PAYMENT",text2:"METHOD"}),!C&&e.jsx("div",{className:"mt-3 rounded-md border border-yellow-300 bg-yellow-50 p-3 text-sm text-yellow-800",children:"Payments run in mock mode locally. Cash on Delivery works as usual."}),e.jsxs("div",{className:"flex gap-3 flex-col lg:flex-row",children:[e.jsxs("div",{onClick:()=>v("stripe"),className:"flex items-center gap-3 border p-2 px-3 cursor-pointer",children:[e.jsx("p",{className:`min-w-3.5 h-3.5 border rounded-full ${u==="stripe"?"bg-green-400":""}`}),e.jsx("img",{className:"h-5 mx-4",src:L.stripe_logo,alt:"Stripe",loading:"lazy",decoding:"async"})]}),e.jsxs("div",{onClick:()=>v("razorpay"),className:"flex items-center gap-3 border p-2 px-3 cursor-pointer",children:[e.jsx("p",{className:`min-w-3.5 h-3.5 border rounded-full ${u==="razorpay"?"bg-green-400":""}`}),e.jsx("img",{className:"h-5 mx-4",src:L.razorpay_logo,alt:"Razorpay",loading:"lazy",decoding:"async"})]}),e.jsxs("div",{onClick:()=>v("cod"),className:"flex items-center gap-3 border p-2 px-3 cursor-pointer",children:[e.jsx("p",{className:`min-w-3.5 h-3.5 border rounded-full ${u==="cod"?"bg-green-400":""}`}),e.jsx("p",{className:"text-gray-500 text-sm font-medium mx-4",children:"CASH ON DELIVERY"})]})]})]}),e.jsx("div",{className:"w-full text-end mt-8",children:e.jsx("button",{type:"submit",className:`bg-black text-white px-16 py-3 text-sm ${S?"opacity-60 cursor-not-allowed":""}`,disabled:S||O(),children:S?"Placing order...":O()?"Cart empty":"PLACE ORDER"})})]})]})};export{ee as default};
